/*!
 * jQuery Plugin - Image Editor 
 *
 * Copyright 2014 
 * Released under the MIT license
 * Date: 2014-2-16
*/

$(function(e){function i(){return{filterApplied:[],removeFromApplied:[],parentContainer:null,canvasID:"",origHTML:"",init:function(e,i){var t=this;t.origHTML=e.html(),t.parentContainer=e,t.initializeWorkingArea(),t.intializeConvas(i,function(e){t.filtersBackForwardButtons(),t.filtersListControls(i),t.applyEffect("normal",i.source,!1,e),t.bindEvents(i)})},initializeWorkingArea:function(){this.parentContainer.empty().css({padding:"0px"}),this.parentContainer.append(e("<div></div>").addClass("bie-editor-controller")).append(e("<div></div>").attr("id","editor-image")).append(e("<div></div>").attr("id","editor-backford-buttons"))},validateFilterBackForwardButtons:function(){this.filterApplied.length>0?this.parentContainer.find(".bie-menu-backpop").removeClass("disabled"):this.parentContainer.find(".bie-menu-backpop").hasClass("disabled")||this.parentContainer.find(".bie-menu-backpop").addClass("disabled"),this.removeFromApplied.length>0?this.parentContainer.find(".bie-menu-forwardpop").removeClass("disabled"):this.parentContainer.find(".bie-menu-forwardpop").hasClass("disabled")||this.parentContainer.find(".bie-menu-forwardpop").addClass("disabled")},filtersBackForwardButtons:function(){this.parentContainer.find("#editor-backford-buttons").append(e("<div></div>").addClass("bie-menu-close-control pull-left")).append(e("<div></div>").addClass("btn-group bie-menu-applied-control").append(e("<a></a>").addClass("bie-menu-backpop btn btn-default btn-sm disabled").attr("id","bie-menu-backpop").html("<i class='glyphicon glyphicon-arrow-left'></i>")).append(e("<a></a>").addClass("bie-menu-forwardpop btn btn-default btn-sm disabled").attr("id","bie-menu-forwardpop").html("<i class='glyphicon glyphicon-arrow-right'></i>")))},intializeConvas:function(i,t){var n=this,a=new Image;a.src=i.source,a.onload=function(){var r=this.width,l=this.height;newHeight=l,newWidth=r,(r>=i.maxWidth||l>=i.maxHeight)&&(r>l?(newWidth=i.maxWidth,newHeight=l/(r/i.maxWidth)):(newHeight=i.maxHeight,newWidth=r/(l/i.maxHeight))),a.remove(),console.log(newWidth+" "+newHeight),n.canvasID="photoCanvas-"+Math.floor(Math.random()*newWidth+1);var o='<canvas id="'+n.canvasID+'" data-caman-hidpi="'+i.source+'" data-caman-hidpi-disabled="true"></canvas>';n.parentContainer.find("#editor-image").html(e("<div></div>").attr({id:"photoCanvas-wrapper"}).css({width:newWidth,height:newHeight}).html(o)),t&&t({width:newWidth,height:newHeight})}},emptyControlArea:function(){this.parentContainer.find(".bie-editor-controller").empty()},applyFilterApplied:function(e){var i=this;if(i.filterApplied.length>0)for(var t=0;t<i.filterApplied.length;t++)!function(t){void 0!=t&&("effect"==t.type?(e.blockEnable&&i.displayBlock(e),i.applyEffect(t.name,!1,function(){e.blockEnable&&i.unblock()})):"interactive"==t.type&&(e.blockEnable&&i.displayBlock(e),i.applyInteractiveFilter(t.name,t.value,function(){e.blockEnable&&i.unblock()})))}(i.filterApplied[t]);else i.revertFilters()},revertFilters:function(){Caman("#"+this.canvasID,function(){this.revert()})},applyEffect:function(i,t,n,a){var r=this;0==t?Caman("#"+r.canvasID,function(){i in this&&(this.revert(!1),this[i]()),this.render(function(){n&&n()})}):Caman("#"+r.canvasID,t,function(){i in this?(this.revert(!1),this[i]()):this.revert(!1),this.render(function(){e("#"+r.canvasID).css({width:a.width,height:a.height}),n&&n()})})},applyInteractiveFilter:function(e,i,t){var i=parseInt(i);Caman("#"+this.canvasID,function(){this.revert(!1),this[e](i),this.render(function(){t&&t()})})},filtersListControls:function(i){for(var n=e("<ul></ul>").addClass("bie-menus"),a=e("<a></a>").addClass("btn btn-default bie-menu-close btn-sm hidden").text("Close"),r=e("<div></div>").addClass("bie-menu-control hidden").append(e("<a></a>").addClass("btn btn-primary bie-menu-save").text("Save").attr({"data-loading-text":"Saving..."})).append("<br/>").append(e("<input></input>").addClass("bie-menu-input").attr({type:"checkbox",name:"is_replaced",disabled:i.is_replaced?!1:!0})).append(" Repleace Original"),l=0;l<t.length;l++)n.append(e("<li></li>").addClass("bie-menu-item").append(e("<div></div>").addClass("bie-menu-action filter-"+t[l]).attr({name:t[l]}).html("<p>"+t[l]+"</p>")));this.parentContainer.find(".bie-editor-controller").append(r).append(n),this.parentContainer.find(".bie-menu-close-control").html(a)},filterControls:function(i){var t=e("<div></div>").addClass("bie-menu-control-apply").append(e("<a></a>").addClass("btn btn-primary bie-menu-apply").html("Apply")),a=e("<a></a>").addClass("btn btn-default bie-menu-back pull-left btn-sm").html("Back"),r=n[i],l=this.buildFiltersList(r);this.parentContainer.find(".bie-editor-controller").append(t).append(l),this.parentContainer.find(".bie-menu-close-control").html(a)},buildFiltersList:function(i){if(1==e.isArray(i)){for(var t=e("<ul></ul>").attr({id:"bie-menu-filters",type:"effect"}),n=0;n<i.length;n++)t.append(e("<li></li>").append(e("<a></a>").attr({id:i[n].filter,angle:void 0!==i[n].angle?i[n].angle:""}).text(i[n].name)));return t}$div=e("<div></div>").attr({id:"bie-menu-filters",type:"interactive"}),$low=e("<div></div>").addClass("bie-menu-filter-low").append(e("<a></a>").addClass("bie-menu-low-action").html("<i class='glyphicon glyphicon-minus'></i>")),$high=e("<div></div>").addClass("bie-menu-filter-high").append(e("<a></a>").addClass("bie-menu-high-action").html("<i class='glyphicon glyphicon-plus'></i>")),$title=e("<div></div>").addClass("bie-menu-filter-title").text(i.name),$wrapper=e("<div></div>").addClass("bie-menu-outter-slider"),$slider=e("<div></div>").addClass("bie-menu-filter-setting").attr({"data-min":i.min,"data-max":i.max,"data-step":i.step,"data-value":i.value,"data-filter":i.filter}),$div.append($low).append($high).append($title).append($wrapper).append($slider),$slider.empty().slider({value:i.value,min:i.min,max:i.max,step:i.step,animate:!0,orientation:"horizontal"});var a=setInterval(function(){$slider.width()>0&&(clearInterval(a),$wrapper.width($slider.width()+20))},100);return $div},displayBlock:function(e){this.parentContainer.find("#photoCanvas-wrapper").block({message:e.blockMessage,overlayCSS:{backgroundColor:"#fff",opacity:.8}})},unblock:function(){this.parentContainer.find("#photoCanvas-wrapper").unblock()},removeActiveFromFilters:function(){this.parentContainer.find("#bie-menu-filters li a").removeClass("active")},addActive:function(e){e.addClass("active")},stackEffect:function(){var e=$filterContainer.find("a.active"),i={type:"effect",name:e.attr("id")};this.filterApplied.push(i)},stackInteractive:function(){var e=$filterContainer.find(".bie-menu-filter-setting"),i={type:"interactive",name:e.attr("data-filter"),value:e.slider("value")};this.filterApplied.push(i)},stackupFilter:function(){$filterContainer=e("#bie-menu-filters");var i=$filterContainer.attr("type");"effect"==i?this.stackEffect():"interactive"==i&&this.stackInteractive()},resetToOriginal:function(e){this.parentContainer.html(this.origHTML),e.onClose&&e.onClose()},clearStackFilter:function(){this.filterApplied=[],this.removeFromApplied=[]},convertBase64ToBlob:function(e){for(var i=atob(e.split(",")[1]),t=new ArrayBuffer(i.length),n=new Uint8Array(t),a=0;a<i.length;a++)n[a]=i.charCodeAt(a);return new Blob([t],{type:"image/jpeg"})},saveCurrentCanvas:function(i,t){var n=this;1==i.remoteSave?Caman("#"+n.canvasID,function(){this.render(function(){var a=this.toBase64("jpg"),r=n.convertBase64ToBlob(a),l=new FormData;l.append("is_replaced",i.is_checked),l.append("image",r),e.ajax({url:i.url,data:l,type:"POST",processData:!1,contentType:!1,dataType:"JSON",success:function(e){i.saveCallBack&&i.saveCallBack(e.message,1),t&&t()},error:function(e){i.saveCallBack&&i.saveCallBack(e.responseJSON.message,0),t&&t()}})})}):Caman("#"+n.canvasID,function(){this.render(function(){this.save("png"),t&&t()})})},removePreviousApplied:function(){var e=this.filterApplied.pop();this.removeFromApplied.push(e)},addPreviousApplied:function(){var e=this.removeFromApplied.pop();this.filterApplied.push(e)},destroyEditor:function(){this.parentContainer.empty()},bindEvents:function(i){var t=this;t.parentContainer.find(".bie-menu-action").unbind().on("click",function(){var n=e(this);t.emptyControlArea(),t.filterControls(n.attr("name")),t.applyFilterApplied(i),t.bindEvents(i)}),t.parentContainer.find(".bie-menu-save").unbind().on("click",function(){var n=e(this);n.button("loading");var a=t.parentContainer.find("input[name='is_replaced']").is(":checked");i.is_checked=a,t.saveCurrentCanvas(i,function(){n.button("reset")})}),t.parentContainer.find(".bie-menu-filter-setting").on("slidechange",function(n,a){t.applyFilterApplied(i);var r=e(this).attr("data-filter"),l=a.value;i.blockEnable&&t.displayBlock(i),t.applyInteractiveFilter(r,l,function(){i.blockEnable&&t.unblock()})}),t.parentContainer.find("#bie-menu-filters li a").unbind().on("click",function(){var n=e(this),a=n.attr("id");i.blockEnable&&t.displayBlock(i),t.removeActiveFromFilters(),t.applyFilterApplied(i),t.addActive(e(this)),t.applyEffect(a,!1,function(){i.blockEnable&&t.unblock()})}),t.parentContainer.find(".bie-menu-low-action").unbind().on("click",function(){var e=t.parentContainer.find(".bie-menu-filter-setting").attr("data-min");t.parentContainer.find(".bie-menu-filter-setting").slider("value",parseInt(e))}),t.parentContainer.find(".bie-menu-high-action").unbind().on("click",function(){var e=t.parentContainer.find(".bie-menu-filter-setting").attr("data-max");t.parentContainer.find(".bie-menu-filter-setting").slider("value",parseInt(e))}),t.parentContainer.find(".bie-menu-back").unbind().on("click",function(){t.emptyControlArea(),t.filtersListControls(i),t.revertFilters(),t.applyFilterApplied(i),t.validateFilterBackForwardButtons(),t.bindEvents(i)}),t.parentContainer.find(".bie-menu-apply").unbind().on("click",function(){t.stackupFilter(),t.emptyControlArea(),t.filtersListControls(i),t.revertFilters(),t.applyFilterApplied(i),t.validateFilterBackForwardButtons(),t.bindEvents(i)}),t.parentContainer.find(".bie-menu-close").unbind().on("click",function(){t.clearStackFilter(),t.revertFilters(),t.destroyEditor(),t.resetToOriginal(i)}),t.parentContainer.find(".bie-menu-backpop").unbind().on("click",function(){t.removePreviousApplied(),t.validateFilterBackForwardButtons(),t.applyFilterApplied(i)}),t.parentContainer.find(".bie-menu-forwardpop").unbind().on("click",function(){t.addPreviousApplied(),t.validateFilterBackForwardButtons(),t.applyFilterApplied(i)})}}}var t=["Effects","Brightness","Contrast","Saturation","Vibrance","Exposure","Hue","Sepia","Gamma","Noise","Clip","Sharpen","Stack Blur"],n={Effects:[{name:"Normal",filter:"normal"},{name:"Vintage",filter:"vintage"},{name:"Lomo",filter:"lomo"},{name:"Clarity",filter:"clarity"},{name:"Sin City",filter:"sinCity"},{name:"Sunrise",filter:"sunrise"},{name:"Cross Process",filter:"crossProcess"},{name:"Orange Peel",filter:"orangePeel"},{name:"Love",filter:"love"},{name:"Grungy",filter:"grungy"},{name:"Jarques",filter:"jarques"},{name:"Pinhole",filter:"pinhole"},{name:"Old Boot",filter:"oldBoot"},{name:"Glowing Sun",filter:"glowingSun"},{name:"Hazy Days",filter:"hazyDays"},{name:"Her Majesty",filter:"herMajesty"},{name:"Nostalgia",filter:"nostalgia"},{name:"Hemingway",filter:"hemingway"},{name:"Concentrate",filter:"concentrate"}],Brightness:{name:"Brightness",filter:"brightness",min:-100,max:100,value:0,step:1},Contrast:{name:"Contrast",filter:"contrast",min:-100,max:100,value:0,step:1},Saturation:{name:"Saturation",filter:"saturation",min:-100,max:100,value:0,step:1},Vibrance:{name:"Vibrance",filter:"vibrance",min:-100,max:100,value:0,step:1},Exposure:{name:"Exposure",filter:"exposure",min:-100,max:100,value:0,step:1},Hue:{name:"Hue",filter:"hue",min:0,max:100,value:0,step:1},Sepia:{name:"Sepia",filter:"sepia",min:0,max:100,value:0,step:1},Gamma:{name:"Gamma",filter:"gamma",min:0,max:10,value:0,step:.1},Noise:{name:"Noise",filter:"noise",min:0,max:100,value:0,step:1},Clip:{name:"Clip",filter:"clip",min:0,max:100,value:0,step:1},Sharpen:{name:"Sharpen",filter:"sharpen",min:0,max:100,value:0,step:1},"Stack Blur":{name:"Stack Blur",filter:"stackBlur",min:0,max:20,value:0,step:1}};mainImageEditor=function(e,t){var n=new i;n.init(e,t)},e.fn.imageEditor=function(i){return this.each(function(){var t=e.extend(e.fn.imageEditor.defaults,i);mainImageEditor(e(this),t)})},e.fn.imageEditor.defaults={source:"",maxWidth:500,maxHeight:400,remoteSave:!1,remoteURL:"",is_repleace:!1,blockEnable:!1,blockMessage:null,onClose:"",saveCallBack:""}}(jQuery));